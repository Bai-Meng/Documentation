# LVM + XFS 格式分区系统

1. CentOS 7 系统创建分区，本次操作以此片vdb为例

   ```shell
   $ yum update -y
   $ pvcreate /dev/vdb  # 创建PV，将新添加的磁盘创建为物理卷
   $ vgcreate swap /dev/vdb  # 创建VG，在新创建的物理卷上创建名称为data的卷组，‘data’可以跟随需求自定义名称
   # 创建LV，在data的卷组上创建名称为mydata的逻辑卷,并使用卷组的所有空间，‘mydata’可以跟随需求自定义名称
   $ lvcreate -l 100%VG -n data mydata
   $ mkfs.xfs /dev/mydata/data  # 格式化逻辑卷，将名称为mydata的逻辑卷格式化为xfs格式
   $ blkid /dev/mydata/data  # 挂载逻辑卷，查询新分区的uuid
   # 将新创建的文件系统以noatime及nodiratime的模式进行挂载，并写入/etc/fstab文件中，以便开机实现自动挂载
   # 需替换下面命令中UUID内容
   $ echo "UUID=ea4b86d4-f2b9-4906-b00d-9fe66551f8cc /opt xfs noatime,nodiratime,inode64 0 0" >> /etc/fstab
   $ mount -a  # 挂载
   ```

2. CentOS 7 系统分区扩容

   ```shell
   # 增加一块新磁盘vdc，查看新增磁盘信息
   $ fdisk -l
   $ lsblk
   $ pvcreate /dev/vdc  # 增加PV
   $ vgextend data /dev/vdc  # 扩展VG
   $ lvextend -l +100%FREE /dev/data/mydata  # 扩展LV
   $ xfs_growfs /dev/data/mydata  # 扩展XFS
   $ xfs_info /dev/data/mydata  # 查看扩展后的信息
   $ df -h  # 查看操作系统空间情况
   
   # brtfs文件系统扩容空间(无需操作，扩展)
   # 直接使用brtfs命令即可。vdd为新增磁盘，opt为挂载目录
   $ btrfs device add /dev/vdc /opt
   $ df -h
   ```

3. Debian 9  系统创建分区

   ```shell
   $ apt-get update -y
   $ apt-get install lvm2
   $ pvcreate /dev/vdb
   $ vgcreate data /dev/vdb
   $ lvcreate -l 100%VG -n mydata data
   $ mkfs.ext4 /dev/data/mydata
   $ echo "/dev/data/mydata     /opt                 ext4       defaults,auto    0 0" >> /etc/fstab
   $ mount -a
   $ df -h
   ```

4. 删除 LVM

   1. 查看卷组VG相关信息

      ```shell
      $ df -h
      Filesystem                  Size  Used Avail Use% Mounted on
      ...
      /dev/vda1                    50G   14G   34G  28% /
      /dev/mapper/omni-data       1.6T  886G  715G  56% /opt/chain/omni
      /dev/mapper/btc-data       1000G  394G  607G  40% /opt/chain/bitcoin
      /dev/mapper/hecochain-data  300G  225G   76G  75% /opt/chain/hecochain
      
      $ lsblk
      NAME             MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
      sr0               11:0    1 16.4M  0 rom
      vdc              253:32   0 1000G  0 disk
      └─btc-data       252:3    0 1000G  0 lvm  /opt/chain/bitcoin
      vdd              253:48   0  800G  0 disk
      └─omni-data      252:0    0  1.6T  0 lvm  /opt/chain/omni
      vdf              253:80   0  800G  0 disk
      └─omni-data      252:0    0  1.6T  0 lvm  /opt/chain/omni
      vdg              253:96   0  300G  0 disk
      └─hecochain-data 252:5    0  300G  0 lvm  /opt/chain/hecochain
      
      $ vgscan
        Reading volume groups from cache.
        Found volume group "btc" using metadata type lvm2
        Found volume group "omni" using metadata type lvm2
        Found volume group "hecochain" using metadata type lvm2
          
      $ pvscan
        PV /dev/vdc   VG btc             lvm2 [<1000.00 GiB / 0    free]
        PV /dev/vdd   VG omni            lvm2 [<800.00 GiB / 0    free]
        PV /dev/vdf   VG omni            lvm2 [<800.00 GiB / 0    free]
        PV /dev/vdg   VG hecochain       lvm2 [<300.00 GiB / 0    free]
        ...
        Total: 10 [<8.40 TiB] / in use: 10 [<8.40 TiB] / in no VG: 0 [0
      ```

   2. 查看卷组 omni 包含的PV、LV信息

      ```shell
      $ vgdisplay -v omni
        --- Volume group ---
        VG Name               omni
        System ID
        Format                lvm2
        Metadata Areas        2
        Metadata Sequence No  4
        VG Access             read/write
        VG Status             resizable
        MAX LV                0
        Cur LV                1
        Open LV               1
        Max PV                0
        Cur PV                2
        Act PV                2
        VG Size               1.56 TiB
        PE Size               4.00 MiB
        Total PE              409598
        Alloc PE / Size       409598 / 1.56 TiB
        Free  PE / Size       0 / 0
        VG UUID               G98fNR-32ze-VDL1-zAd3-aah2-e4Hk-m52q0a
      
        --- Logical volume ---
        LV Path                /dev/omni/data
        LV Name                data
        VG Name                omni
        LV UUID                YiyowX-IU2G-Q9CI-2mze-qmko-t2kV-aRyDZv
        LV Write Access        read/write
        LV Creation host, time bj-prod-chain-eth-btc-01b, 2021-01-05 17:14:58 +0800
        LV Status              available
        # open                 1
        LV Size                1.56 TiB
        Current LE             409598
        Segments               2
        Allocation             inherit
        Read ahead sectors     auto
        - currently set to     8192
        Block device           252:0
      
        --- Physical volumes ---
        PV Name               /dev/vdd
        PV UUID               9bjDlb-Ealf-YteL-QR3e-1bDQ-WKPI-9X0Vkm
        PV Status             allocatable
        Total PE / Free PE    204799 / 0
      
        PV Name               /dev/vdf
        PV UUID               BQ7E5S-1wNG-C0ek-PEhm-2Glw-1eid-HcjYfH
        PV Status             allocatable
        Total PE / Free PE    204799 / 0
      ```

   3. 卸载卷组的逻辑卷LV

      要卸载对应卷组VG的所有逻辑卷LV。从上面的信息可以看出对应的卷组 omni 只有 /dev/omni/data 这个逻辑卷LV

      ```shell
      $ umount /dev/omni/data  # 如果还用进程在使用对应逻辑卷的文件，就必须强制卸载挂接点。
      ```

   4. 删除逻辑卷LV

      ```shell
      $ lvremove /dev/omni/data
      Do you really want to remove active logical volume omni/data? [y/n]: y
        Logical volume "data" successfully removed
      ```

      验证LV是否删除

      ```shell
      $ lvdisplay | grep "/dev/omni/data"
      ```

   5. 删除卷组VG

      采用安全的方式删除卷组VG，则必须使用 vgchange -a n omni 关闭了omni，然后才可以删除它。

      ```shell
      $ vgchange -a n omni
        0 logical volume(s) in volume group "omni" now active
      $ vgremove omni
        Volume group "omni" successfully removed
      ```

      验证卷组VG是否删除

      ```shell
      $ vgscan
        Reading volume groups from cache.
        Found volume group "btc" using metadata type lvm2
        Found volume group "hecochain" using metadata type lvm2
        Found volume group "eth" using metadata type lvm2
        Found volume group "blockbook" using metadata type lvm2
        Found volume group "bsc" using metadata type lvm2
      ```

   6. 删除物理卷PV

      ```shell
      $ pvremove /dev/vdd /dev/vdf
        Labels on physical volume "/dev/vdd" successfully wiped.
        Labels on physical volume "/dev/vdf" successfully wiped.
      $ pvscan
        PV /dev/vdc   VG btc             lvm2 [<1000.00 GiB / 0    free]
        PV /dev/vdg   VG hecochain       lvm2 [<300.00 GiB / 0    free]
        PV /dev/vdb   VG eth             lvm2 [<2.15 TiB / 0    free]
        PV /dev/vde   VG blockbook       lvm2 [<1000.00 GiB / 0    free]
        PV /dev/vdh   VG bsc             lvm2 [<500.00 GiB / 0    free]
        PV /dev/vdi   VG bsc             lvm2 [<500.00 GiB / 0    free]
        PV /dev/vdj   VG bsc             lvm2 [<500.00 GiB / 0    free]
        PV /dev/vdk   VG bsc             lvm2 [<1000.00 GiB / 0    free]
        Total: 8 [<6.84 TiB] / in use: 8 [<6.84 TiB] / in no VG: 0 [0   ]
      ```

   7. 编辑/etc/fstab，删除对应挂载信息

      ```shell
      $ vim /etc/fstab
      ```

   8. 腾讯云卸载磁盘

      ```shell
      # 查看当前系统内的磁盘，这里对应控制台的磁盘id和系统内部标识
      $ ll /dev/disk/by-id/ | egrep "vdf|vdg"
      ...
      lrwxrwxrwx 1 root root  9 Jun 11 12:49 virtio-disk-58gkencf -> ../../vdf
      lrwxrwxrwx 1 root root  9 Apr 14 17:06 virtio-disk-k5cy90yp -> ../../vdg
      ```

      

5. 增加 LVM 容量

   ```shell
   # 将新硬盘分区并转成pv
   $ vgextend data /dev/vdc
   $ lvextend -l +100%FREE /dev/data/mydata
   # 或使用
   $ lvresize -L +7G /dev/data/mydata
   # 感觉对lv容量操作使用lvresize较好
   $ resize2fs -f /dev/data/mydata
   ```

6. LVM 扩展命令

   ```shell
   $ lvreduce  # 减少lv的容量
   $ vgreduce  # 从vg中抽出pv
   $ pvmove  # 将组中的指定pv上的数据移走，一般是pv出错替换硬盘时使用
   ```

7. 移除LVM中的硬盘**请不要轻易缩容和移除硬盘**

   移除硬盘请参考[此处](http://mnstory.net/2017/10/20/lvm-reduce/)文档

   ```shell
   $ pvmove /dev/sdd  # 将当前pv的的数据移动到卷组中的其他pv中
   $ vgreduce vg0 /dev/sdd  # 将硬盘/dev/sdd从卷组vg0中移除
   $ pvremove /dev/sdd  # 将sdd硬盘从pv中移除
   ```

   

# php72 环境

1. 配置 PHP72 环境

   ```shell
   $ yum install epel-release
   $ cd /opt/
   $ yum install http://rpms.remirepo.net/enterprise/remi-release-7.rpm -y
   $ yum install yum-utils -y
   $ yum update -y
   $ yum install php72 -y
   $ php72 -v
   $ yum install php72-php-fpm php72-php-gd php72-php-json php72-php-mbstring php72-php-mysqlnd php72-php-xml php72-php-xmlrpc php72-php-opcache -y
   $ systemctl enable php72-php-fpm.service
   $ systemctl start php72-php-fpm.service
   $ systemctl status php72-php-fpm.service
   $ cd /etc/opt/remi/php72/php-fpm.d/
   $ cd /etc/opt/remi/php72
   $ echo '<?php phpinfo(); ?>' | php 2>&1 |grep -i error_log
   
   # Ubuntu
   $ sudo apt-get install php7.2 php7.2-fpm php7.2-mysql
   ```

2. 配置 phpredis 环境

   ```shell
   $ php72 -info | grep redis
   $ php72 -m | grep redis
   
   # yum list php
   # yum remove php.x86_64
   $ rpm -qa | grep php
   $ rpm -e php-cli-5.4.16-48.el7.x86_64
   $ rpm -e php-common-5.4.16-48.el7.x86_64
   $ rpm -e php-mysql-5.4.16-48.el7.x86_64
   $ rpm -e php-pdo-5.4.16-48.el7.x86_64
   
   $ yum install -y php72-php-devel pcre-devel
   $ cd /tmp
   $ wget https://github.com/phpredis/phpredis/archive/refs/tags/5.3.4.tar.gz
   $ tar -zxf 5.3.4.tar.gz && cd phpredis-5.3.4/
   $ /opt/remi/php72/root/usr/bin/phpize
   $ ./configure  --with-php-config=/opt/remi/php72/root/usr/bin/php-config
   $ make && make install
   
   $ cd /etc/opt/remi/php72/php.d/
   $ echo "extension=/opt/remi/php72/root/usr/lib64/php/modules/redis.so" > /etc/opt/remi/php72/php.d/redis.ini
   
   $ systemctl restart php72-php-fpm.service
   $ php72 -m | grep redis
   ```




# 设置 GitHub 代理

```shell
$ git config --global url."https://hub.fastgit.org".insteadOf https://github.com
```



# GoLang 环境

```shell
# 下载地址：https://golang.google.cn/dl/
$ GO_VERSION="1.17.3"
$ wget https://golang.google.cn/dl/go${GO_VERSION}.linux-amd64.tar.gz
$ tar -zxf go${GO_VERSION}.linux-amd64.tar.gz -C /usr/local/
$ wget https://golang.google.cn/dl/go${GO_VERSION}.linux-amd64.tar.gz
$ echo -e "export GOROOT=/usr/local/go \nexport PATH=\$GOROOT/bin:\$PATH \nexport GOPATH=/opt/go" > /etc/profile.d/go.sh
$ source /etc/profile
$ go version

# 设置golang代理
$ export GOPROXY=https://goproxy.cn
$ export GOPROXY=https://athens.azurefd.net
```



# node 环境

```shell
# 下载地址：https://nodejs.org/dist
$ NODE_VERSION="v16.9.1"
$ wget https://nodejs.org/dist/${NODE_VERSION}/node-${NODE_VERSION}-linux-x64.tar.gz
$ tar -zxf node-${NODE_VERSION}-linux-x64.tar.gz
$ mv node-${NODE_VERSION}-linux-x64 /opt/node
$ echo -e "export NODE=/opt/node\nexport PATH=\$NODE/bin:\$PATH" > /etc/profile.d/node.sh
$ source /etc/profile
$ node -v
$ chown -R root.root /opt/node
$ npm install -g cnpm --registry=https://registry.npm.taobao.org  # 设置淘宝cnpm环境
$ cnpm install apidoc -g
$ cnpm install yarn -g
# pm2使用
$ cnpm install pm2 -g
$ pm2 list
$ pm2 log
$ pm2 stop ${SERVER_NAME}
$ pm2 delete ${SERVER_NAME}
$ pm2 start cnpm --name "${SERVER_NAME}" -- run start
# node版本管理工具
$ curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash
$ nvm install v14
```



# 部署 Python3.8 服务

1. 安装依赖包

   ```shell
   # CentOS 7
   $ yum install -y centos-release-scl zlib* openssl-devel
   $ yum install -y devtoolset-9-gcc devtoolset-9-gcc-c++ devtoolset-9-binutils
   $ yum install -y libffi-devel
   $ gcc --version
   $ echo "source /opt/rh/devtoolset-9/enable" >>/etc/profile
   $ . /etc/profile
   $ gcc --version
   # Ubuntu 18.04
   $ sudo apt build-dep python3
   ```

2. 编译安装

   ```shell
   $ wget https://www.python.org/ftp/python/3.8.8/Python-3.8.8.tgz
   $ tar -zxf Python-3.8.8.tgz
   $ cd Python-3.8.8/
   $ ./configure --enable-optimizations --prefix=/opt/python38 --with-ssl
   $ make && make install
   # 定义环境变量
   $ echo -e "export PATH=/opt/python38/bin:\$PATH" > /etc/profile.d/python3.8.sh
   $ source /etc/profile
   ```

3. 安装相关工具包

   ```shell
   $ pip3.8 install --upgrade pip Django Pillow Pillow-PIL PyMySQL asgiref certifi chardet cos-python-sdk-v5 dicttoxml django-redis idna migrate pytz redis requests setuptools six sqlparse urllib3 DingtalkChatbot PyYAML aop et-xmlfile html-table jdcal jsonpath numpy opencv-python openpyxl panda pandas pyaml python-dateutil tencentcloud-sdk-python yagmail verse
   ```

## python pip 使用国内镜像源

1. 国内源列表

   清华 `https://pypi.tuna.tsinghua.edu.cn/simple`

   阿里云 `http://mirrors.aliyun.com/pypi/simple/`

   中国科技大学 `https://pypi.mirrors.ustc.edu.cn/simple/`

   华中理工大学 `http://pypi.hustunique.com/`

   山东理工大学 `http://pypi.sdutlinux.org/ `

   豆瓣 `http://pypi.douban.com/simple/`

   note：新版ubuntu要求使用https源，要注意。

   **例如：`pip3 install -i https://pypi.doubanio.com/simple/ 包名`**

2. 临时使用

   可以在使用pip的时候加参数 `-i https://pypi.tuna.tsinghua.edu.cn/simple`

   例如：`pip install -i https://pypi.tuna.tsinghua.edu.cn/simple pyspider`，这样就会从清华这边的镜像去安装pyspider库。

3. 永久修改

   [Linux](http://lib.csdn.net/base/linux)下，修改 `~/.pip/pip.conf` (没有就创建一个文件夹及文件。文件夹要加“.”，表示是隐藏文件夹)

   内容如下：

   ```shell
   [global]
   index-url = https://pypi.tuna.tsinghua.edu.cn/simple
   [install]
   trusted-host=mirrors.aliyun.com
   ```

   windows下，直接在user目录中创建一个pip目录，再新建文件pip.ini。（例如：C:\Users\WQP\pip\pip.ini）内容同上。

## 虚拟环境使用

```shell
$ python3 -m venv v-env  # 创建虚拟环境
$ source v-env/bin/activate  # 激活环境
$ deactivate  # 停用虚拟环境
```



# Ubuntu18.04 设置开机自启动服务

Ubuntu-18.04不能像ubuntu14一样通过编辑rc.local来设置开机启动脚本，通过下列简单设置后，可以使rc.local重新发挥作用。

1. 编辑rc-local.service文件

   ```shell
   $ vim /etc/systemd/system/rc-local.service
   # 在rc-local.service文件中加入以下内容
   [Install]  
   WantedBy=multi-user.target  
   Alias=rc-local.service
   ```

   一般启动文件需要三个组成部分

   > [Unit]段: 启动顺序与依赖关系
   >
   > [Service] 段: 启动行为,如何启动，启动类型
   >
   > [Install] 段: 定义如何安装这个配置文件，即怎样做到开机启动

2. 创建文件rc.local

   **Ubuntu-18.04 默认是没有 /etc/rc.local 这个文件的，需要自己创建**

   ```shell
   $ vim /etc/rc.local
   
   # 将下列内容复制进rc.local文件
   #!/bin/sh -e
   #
   # rc.local
   # This script is executed at the end of each multiuser runlevel.
   # Make sure that the script will "exit 0" on success or any other
   # value on error.
   # In order to enable or disable this script just change the execution
   # bits.
   # By default this script does nothing.
   sudo echo "在这里行写入你需自启动服务的脚本" > /usr/local/rc.local.log
   exit 0
   ```

3. 给rc.local加上权限

   ```shell
   $ chmod +x /etc/rc.local
   ```

4. 服务管理

   ```shell
   $ systemctl enable rc-local
   $ systemctl start rc-local.service  # 启动服务
   $ systemctl status rc-local.service  # 检查状态
   ```

5. 查看日志文件

   ```shell
   $ tail -n 10 /usr/local/rc.local.log
   ```

   

# 系统时间同步

```shell
$ vim /var/spool/cron/root
# 同步系统时间-腾讯云
*/10 * * * * /usr/sbin/ntpdate time1.cloud.tencent.com >/dev/null 2>&1
# 同步系统时间-阿里云
*/10 * * * * /usr/sbin/ntpdate ntp1.aliyun.com >/dev/null 2>&1
# 阿里云内网
* * * * * /usr/sbin/ntpdate ntp.cloud.aliyuncs.com >/dev/null 2>&1

# 修改时区
$ tzselect
$ rm -f /etc/localtime
$ ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
$ date
```



# 系统sudo权限设置

```tex
sudo权限：/bin/whoami 为只读用户，/bin/*,/sbin/* 为root权限

设置常规权限
ALL,!/bin/bash,!/bin/su,!/bin/vim /etc/sudoers,!/usr/bin/vim /etc/sudoers,!/usr/sbin/visudo,!/usr/bin/sudo -i,!/bin/chmod 777 /etc/*,!/bin/chmod 777 *,!/bin/chmod 777,!/bin/chmod -R 777 *,!/bin/rm /,!/bin/rm /srv,!/bin/rm /data,!/bin/rm /opt,!/bin/rm /*,!/bin/rm /etc,!/bin/rm /etc/*,!/bin/rm /root,!/bin/rm /root/*,!/bin/rm /bin,!/bin/rm /bin/*,!/bin/rm /usr/bin,!/bin/rm /usr/bin/*,!/bin/rm /usr/sbin,!/bin/rm /usr/sbin/*,!/usr/bin/passwd,!/bin/passwd,!/bin/kill
```



```shell
$ visudo

root    ALL=(ALL:ALL) ALL

# Members of the admin group may gain root privileges
%admin ALL=(ALL) ALL

# Allow members of group sudo to execute any command
%sudo   ALL=(ALL:ALL) ALL

# See sudoers(5) for more information on "#include" directives:

#includedir /etc/sudoers.d
ubuntu  ALL=(ALL:ALL) NOPASSWD: ALL
deploy ALL=(ALL) NOPASSWD: ALL
dev ALL=(ALL) NOPASSWD: ALL
ops ALL=(ALL) NOPASSWD: ALL
wh ALL=(ALL) NOPASSWD: /bin/whoami
```

# 添加系统用户

```shell
$ groupadd deploy; useradd deploy -m -s /bin/bash -d /home/deploy -g deploy
$ useradd guest -m -s /bin/bash -d /home/guest -g deploy
```

参数说明：

```shell
-s /sbin/nologin设置不能登陆-s /bin/false(老方法) 也行
-d 设置用户主目录
-g 用户组
-m 创建用户目录
更改用户登录权限
在增加了-s /sbin/nologin参数后，那么这个帐号就不能登陆了，如果想要恢复登陆使用
usermod -s /bin/bash username
禁用用户登录权限
usermod -s /sbin/nologin username
```

# 更换docker源

```shell
$ vim /etc/docker/daemon.json
$ tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://1tpafwoy.mirror.aliyuncs.com"]
}
EOF

$ cat /etc/docker/daemon.json 
$ systemctl daemon-reload
$ systemctl restart docker

```


